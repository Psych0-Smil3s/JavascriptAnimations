<html>
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.6/jquery-ui.min.js"></script>-->
	<style type="text/css">
		/******************************
		 * The following styles are only
		 * for browser based testing.
		 ******************************/
		.wrapper {
			position: relative;
			width: 600px;
			margin: 100px;
			overflow: visible;
			border-radius: 5px;
		}
		.wrapper .editor {
			margin-top: 10px !important;
		}
		/******************************
		 * Message styles 
		 ******************************/
* {
	overflow: auto;
	margin: 0;
	padding: 0;
}
.loader {
	position: absolute;
}
.plaudits-4 {
	border: solid 1px #000;
	border-radius: inherit;
	min-height: 113px;
	height:auto !important;
	height: 113px;
    background-color: #c1f0ff;
}
.plaudits-4 .canvas {
	width: 100%;
	height: 113px;
}
.plaudits-4 .plaudits-4-header {
	width: 100%;
	position: absolute;
	z-index: 11;
	top: 0;
	left: 0;
}
.plaudits-4-header .timestamp, .plaudits-4-header .flags, .plaudits-4-header .nickname {
	float: left;
	padding: 2px 5px;
	color: #666;
}
.plaudits-4-header .timestamp, .plaudits-4-header .flags {
	float: right;
	padding-left: 10px;
}
.plaudits-4.msie canvas {
    display: none;
}
.plaudits-4.editor, .plaudits-4.msie {
	background: #c1f0ff url(http://media.parlingo.com/website/live/messagepacks/plaudits/scene.png) repeat-x;
}
.plaudits-4.editor .blob, .plaudits-4.msie .blob {
    margin: 0 auto;
    width: 67px;
    height: 90px;
    margin-top: 10px;
    background: url(http://media.parlingo.com/website/live/messagepacks/plaudits/clap2.png) center center no-repeat;
}
@media only screen and (-webkit-min-device-pixel-ratio: 2) {
    .plaudits-4.editor, .plaudits-4.msie {
        background: #c1f0ff url(http://media.parlingo.com/website/live/messagepacks/plaudits/scene.png) repeat-x;
    }
    .plaudits-4.editor span.blob, .plaudits-4.msie span.blob {
        margin: 0 auto;
        width: 67px;
        height: 90px;
        margin-top: 10px;
        background: url(http://media.parlingo.com/website/live/messagepacks/plaudits/X2/clap2.png) center center no-repeat;
    }
}
	</style>
</head>
<body>
	<div class="wrapper">

<script type="text/javascript" defer="defer">
	/**
	 * Provide a cross-browser/fall back
	 * solution for the requestAnimationFrame.
	 */
	window.requestAnimFrame = (function(){ 
		return  window.requestAnimationFrame       ||  
				window.webkitRequestAnimationFrame ||  
				window.mozRequestAnimationFrame    ||  
				window.oRequestAnimationFrame      ||  
				window.msRequestAnimationFrame     ||  
				function( callback ){ 
					window.setTimeout(callback, 1000 / 60); 
				};
	})();

	/**
	 * Preload the scene images.
	 */
	var pixelRatio = (window.devicePixelRatio === 1 ? 1 : 2),
        lastUpdateTime = 0,
        acDelta = 0,
        msPerFrame = 1000 / (25 * pixelRatio), //FPS
		plaudits_4_imagesLoaded = 0,
		plaudits_4_totalImages = 2,
        plaudits_4_baseY = 20,
        plaudits_4_baseURL = 'http://media.parlingo.com/website/live/messagepacks/plaudits/',

		plaudits_4_sprite = new Image(),
        plaudits_4_frameCount = 90,
		plaudits_4_sprite_width,
		plaudits_4_sprite_height,

        plaudits_4_spriteBoo = new Image(),
        plaudits_4_frameCountBoo = 70,
        plaudits_4_sprite_widthBoo,
        plaudits_4_sprite_heightBoo;

        plaudits_4_sprite.onload = function() {
		plaudits_4_imagesLoaded++;
		plaudits_4_sprite_width  =  this.width;
		plaudits_4_sprite_height =  Math.floor(this.height / plaudits_4_frameCount);
	};
	plaudits_4_sprite.src =  plaudits_4_baseURL + (pixelRatio === 1 ? '' : 'X2/') + 'clap2_1x90.png';

    plaudits_4_spriteBoo.onload = function() {
        plaudits_4_imagesLoaded++;
        plaudits_4_sprite_widthBoo  = this.width;
        plaudits_4_sprite_heightBoo = Math.floor(this.height / plaudits_4_frameCountBoo);
    };
    plaudits_4_spriteBoo.src = plaudits_4_baseURL + (pixelRatio === 1 ? '' : 'X2/') + 'boo_1x70.png';

    function plaudits_4_render(c) {

        if (plaudits_4_imagesLoaded < plaudits_4_totalImages)
            return;

        var can = $('canvas#' + c);

        can.each(function() {
            var tick = $(this).parent().data('tick'),
                ctx = this.getContext('2d');

            ctx.clearRect(0, 0, this.width, this.height);
            ctx.save();

            var scene = plaudits_5_drawScene(this);
            ctx.drawImage(scene, 0, 0, this.width, this.height);

            // clap middle
            var frame = tick % plaudits_4_frameCount,
                pos = frame * plaudits_4_sprite_height,
                reducedWidth =  Math.floor(plaudits_4_sprite_width / 1.7),
                reducedHeight = Math.floor(plaudits_4_sprite_height / 1.7);


            ctx.drawImage(plaudits_4_sprite, 0, pos, plaudits_4_sprite_width, plaudits_4_sprite_height, Math.floor((this.width / 2) - (reducedWidth / 2) + (reducedWidth / 2)), Math.floor((plaudits_4_baseY + 5) * pixelRatio), reducedWidth, reducedHeight);

            // Boo
            /*frame = tick % plaudits_4_frameCountBoo,
            pos = frame * plaudits_4_sprite_heightBoo;
            reducedWidth =  Math.floor(plaudits_4_sprite_widthBoo / 2.2),
            reducedHeight = Math.floor(plaudits_4_sprite_heightBoo / 2.2);

            ctx.drawImage(plaudits_4_spriteBoo, 0, pos, plaudits_4_sprite_widthBoo, plaudits_4_sprite_heightBoo, Math.floor((this.width / 2) - (reducedWidth * 5) + (reducedWidth * 3.3)), Math.floor((plaudits_4_baseY - 12) * pixelRatio), reducedWidth, reducedHeight);
            */

            // clap at back
            /*reducedWidth =  Math.floor(plaudits_4_sprite_width / 2.2),
            reducedHeight = Math.floor(plaudits_4_sprite_height / 2.2),
            frame = (tick + 8) % plaudits_4_frameCount,
            pos = frame * plaudits_4_sprite_height;

            ctx.drawImage(plaudits_4_sprite, 0, pos, plaudits_4_sprite_width, plaudits_4_sprite_height, Math.floor((this.width / 2) - (reducedWidth / 2) - (reducedWidth / 4)), Math.floor((plaudits_4_baseY - 10) * pixelRatio), reducedWidth, reducedHeight);
            */

            // Clap far left
            reducedWidth =  Math.floor(plaudits_4_sprite_width / 1.7),
            reducedHeight = Math.floor(plaudits_4_sprite_height / 1.7),
            frame = (tick + 17) % plaudits_4_frameCount,
            pos = frame * plaudits_4_sprite_height;

            ctx.drawImage(plaudits_4_sprite, 0, pos, plaudits_4_sprite_width, plaudits_4_sprite_height, Math.floor((this.width / 2) - (reducedWidth / 2) - (reducedWidth * 1.8)) , Math.floor((plaudits_4_baseY + 5) * pixelRatio), reducedWidth, reducedHeight);


            // clap front left
            reducedWidth =  Math.floor(plaudits_4_sprite_width / 1.3),
            reducedHeight = Math.floor(plaudits_4_sprite_height / 1.3),
            frame = (tick + 30) % plaudits_4_frameCount,
            pos = frame * plaudits_4_sprite_height;

            ctx.drawImage(plaudits_4_sprite, 0, pos, plaudits_4_sprite_width, plaudits_4_sprite_height, Math.floor((this.width / 2) - (reducedWidth / 2) - (reducedWidth / 2.1)), Math.floor((plaudits_4_baseY + 15) * pixelRatio), reducedWidth, reducedHeight);

            // clap front right
            reducedWidth =  Math.floor(plaudits_4_sprite_width / 1.2),
            reducedHeight = Math.floor(plaudits_4_sprite_height / 1.2),
            frame = (tick + 8) % plaudits_4_frameCount,
            pos = frame * plaudits_4_sprite_height;

            ctx.drawImage(plaudits_4_sprite, 0, pos, plaudits_4_sprite_width, plaudits_4_sprite_height, Math.floor((this.width / 2) - (reducedWidth / 2) + (reducedWidth * 1.3)), Math.floor((plaudits_4_baseY + 12) * pixelRatio), reducedWidth, reducedHeight);

            ctx.restore();

            $(this).parent().data('tick', tick+1);
        });
	}

    function plaudits_5_drawScene(par) {
        if (!par.scene) {
            var canvas = document.createElement('canvas'),
                    ctx = canvas.getContext('2d');

            canvas.width = par.width;
            canvas.height = par.height;

            // green base
            ctx.fillStyle = '#94d5a5';
            ctx.fillRect(0, Math.floor((par.height / 5) * 3), par.width, par.height);

            par.scene = canvas;
        }
        return par.scene;
    }

    function plaudits_4_draw(c) {

        window.requestAnimFrame(
                function() {plaudits_4_draw(c)
        });

        var delta = Date.now() - lastUpdateTime;
        if (acDelta > msPerFrame)
        {
            acDelta = 0;
            plaudits_4_render(c);
        }
        else
        {
            acDelta += delta;
        }
        lastUpdateTime = Date.now();
    }

	function plaudits_4_loaded(preloaded) {
		var me = $(this).closest('.plaudits-4');
		if (navigator.userAgent.toLowerCase().indexOf('msie') === -1) {
            me.removeClass('msie');
			setTimeout(function() {
				me.data('tick', 0);
				var canvas = me.find('.canvas'),
					width = me.width(),
					height = me.height();
				canvas.css({
					width : width,
					height : height
				});
				if (pixelRatio) {
					canvas.attr({
						'width' : width * pixelRatio,
						'height' : height * pixelRatio
					});        
				}
				var id = Math.floor(Math.random() * new Date().getTime());
				canvas.attr('id', id);

                plaudits_4_draw(id);

			}, 200);
		}
	}
</script>
<div class="plaudits-4 msie">
	<img src="http://media.parlingo.com/website/live/messagepacks/gavintest/shared/tinytrans.gif" class="loader" onload="plaudits_4_loaded.call(this)">
	<div class="plaudits-4-header">
		<span class="timestamp"></span>
		<span class="flags"></span>
		<strong class="nickname"></strong>
	</div>
    <div class="blob"></div>
	<canvas class="canvas"></canvas>
</div>
<div class="plaudits-4 editor">
    <div class="blob"></div>
</div>
	</div>
</body>
</html>