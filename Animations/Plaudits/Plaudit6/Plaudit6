<html>
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.6/jquery-ui.min.js"></script>-->
    <style type="text/css">
        /******************************
         * The following styles are only
         * for browser based testing.
         ******************************/
        .wrapper {
            position: relative;
            width: 600px;
            margin: 100px;
            overflow: visible;
            border-radius: 5px;
        }
        .wrapper .editor {
            margin-top: 10px !important;
        }
/******************************
 * Message styles
 ******************************/
* {
    overflow: auto;
    margin: 0;
    padding: 0;
}
.loader {
    position: absolute;
}
.plaudits-6 {
    border: solid 1px #999;
    border-radius: inherit;
    min-height: 113px;
    height:auto !important;
    height: 113px;
    background-color: #c1f0ff;
}
.plaudits-6 .canvas {
    width: 100%;
    height: 113px;
}
.plaudits-6 .plaudits-6-header {
    width: 100%;
    position: absolute;
    z-index: 11;
    top: 0;
    left: 0;
}
.plaudits-6-header .timestamp, .plaudits-6-header .flags, .plaudits-6-header .nickname {
    float: left;
    padding: 2px 5px;
    color: #666;
}
.plaudits-6-header .timestamp, .plaudits-6-header .flags {
    float: right;
    padding-left: 10px;
}
.plaudits-6.msie canvas {
    display: none;
}
.plaudits-6.editor canvas {
    display: none;
}
.plaudits-6.editor, .plaudits-6.msie {
    background: #c1f0ff url(http://media.parlingo.com/website/live/messagepacks/plaudits/scene.png) repeat-x;
}
.plaudits-6.editor .blob, .plaudits-6.msie .blob {
    margin: 0 auto;
    width: 70px;
    height: 91px;
    margin-top: 10px;
    background: url(http://media.parlingo.com/website/live/messagepacks/plaudits/drum2.png) center center no-repeat;
}
@media only screen and (-webkit-min-device-pixel-ratio: 2) {
    .plaudits-6.editor, .plaudits-6.msie {
        background: #c1f0ff url(http://media.parlingo.com/website/live/messagepacks/plaudits/scene.png) repeat-x;
        background-size: 456px 113px;
    }
    .plaudits-6.editor .blob, .plaudits-6.msie .blob {
        margin: 0 auto;
        margin-top: 10px;
        background: url(http://media.parlingo.com/website/live/messagepacks/plaudits/X2/drum2.png)  no-repeat;
        background-size: 70px 91px;
    }
}
@-moz-document url-prefix() {
    .plaudits-6.editor, .plaudits-6.msie {
        background: #c1f0ff url(http://media.parlingo.com/website/live/messagepacks/plaudits/scene.png) repeat-x;
        background-size: 456px 113px;
    }
    .plaudits-6.editor .blob, .plaudits-6.msie .blob {
        margin: 0 auto;
        margin-top: 10px;
        background: url(http://media.parlingo.com/website/live/messagepacks/plaudits/X2/drum2.png)  no-repeat;
        background-size: 70px 91px;
    }
}
    </style>
</head>
<body>
<div class="wrapper">
    <script type="text/javascript" defer="defer">

        /**
         * Provide a cross-browser/fall back
         * solution for the requestAnimationFrame.
         */
        window.requestAnimFrame = (function(){
            return  window.requestAnimationFrame       ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame    ||
                    window.oRequestAnimationFrame      ||
                    window.msRequestAnimationFrame     ||
                    function( callback ){
                        window.setTimeout(callback, 1000 / 60);
                    };
        })();

        /**
         * Preload the scene images.
         */
        var pixelRatio = (window.devicePixelRatio === 1 ? 1 : 2),
            lastUpdateTime = 0,
            acDelta = 0,
            msPerFrame = 1000 / (25 * pixelRatio), //FPS
            plaudits_4_baseY = 20,
            plaudits_6_imagesLoaded = 0,
            plaudits_6_totalImages = 1,
            plaudits_6_frameCount = 60,

            plaudits_6_isSoundSupported = false,
            plaudits_6_soundPlayCount = 0,
            plaudits_6_stopSoundLoop = false,

            plaudits_6_sprite = new Image(),
            plaudits_6_sprite_width,
            plaudits_6_sprite_height;

        plaudits_6_sprite.onload = function() {
            plaudits_6_imagesLoaded++;
            plaudits_6_sprite_width = this.width;
            plaudits_6_sprite_height = Math.floor(this.height / plaudits_6_frameCount);
        };
        plaudits_6_sprite.src = 'http://media.parlingo.com/website/live/messagepacks/plaudits/' + (pixelRatio === 1 ? '' : 'X2/') + 'drum2_1x60.png';


        function plaudits_6_render(c,clip) {

            if (plaudits_6_imagesLoaded < plaudits_6_totalImages)
                return;

            var can = $('canvas#' + c);

            can.each(function() {
                var tick = $(this).parent().data('tick'),
                        ctx = this.getContext('2d');

                ctx.clearRect(0, 0, this.width, this.height);
                ctx.save();

                var scene = plaudits_6_drawScene(this);
                ctx.drawImage(scene, 0, 0, this.width, this.height);

                var currentOriginalFrame = tick % plaudits_6_frameCount;
                if (plaudits_6_isSoundSupported && !plaudits_6_stopSoundLoop && currentOriginalFrame == 0) // sound trigger
                    plaudits_6_playSound(clip);

                var frame = (tick + 30) % plaudits_6_frameCount,
                        pos = frame * plaudits_6_sprite_height,
                        reducedWidth  = Math.floor(plaudits_6_sprite_width / 1.4),
                        reducedHeight = Math.floor(plaudits_6_sprite_height / 1.4);

                ctx.drawImage(plaudits_6_sprite, 0, pos, plaudits_6_sprite_width, plaudits_6_sprite_height, Math.floor(((this.width / 2) - (plaudits_6_sprite_width / 2))  - (reducedWidth)), Math.floor((plaudits_4_baseY + 20) * pixelRatio), reducedWidth, reducedHeight);

                frame = (tick + 15) % plaudits_6_frameCount,
                        pos = frame * plaudits_6_sprite_height
                        reducedWidth  = Math.floor(plaudits_6_sprite_width / 1.4),
                        reducedHeight = Math.floor(plaudits_6_sprite_height / 1.4);

                ctx.drawImage(plaudits_6_sprite, 0, pos, plaudits_6_sprite_width, plaudits_6_sprite_height, Math.floor((this.width / 2) - (plaudits_6_sprite_width / 2)), Math.floor((plaudits_4_baseY - 2)  * pixelRatio), reducedWidth, reducedHeight);


                frame = (tick) % plaudits_6_frameCount,
                        pos = frame * plaudits_6_sprite_height
                        reducedWidth  = Math.floor(plaudits_6_sprite_width / 1.4),
                        reducedHeight = Math.floor(plaudits_6_sprite_height / 1.4);

                ctx.drawImage(plaudits_6_sprite, 0, pos, plaudits_6_sprite_width, plaudits_6_sprite_height, Math.floor(((this.width / 2) - (plaudits_6_sprite_width / 2)) + (reducedWidth)), Math.floor((plaudits_4_baseY + 20) * pixelRatio), reducedWidth, reducedHeight);

                ctx.restore();

                $(this).parent().data('tick', tick+1);
            });
        }

        function plaudits_6_drawScene(par) {
            if (!par.scene) {
                var canvas = document.createElement('canvas'),
                        ctx = canvas.getContext('2d');

                canvas.width = par.width;
                canvas.height = par.height;

                // green base
                ctx.fillStyle = '#94d5a5';
                ctx.fillRect(0, Math.floor((par.height / 5) * 3), par.width, par.height);

                par.scene = canvas;
            }
            return par.scene;
        }

        function plaudits_6_draw(c, staticImg, clip) {

            if (staticImg)
                plaudits_6_render(c,clip);
            else
            {
                window.requestAnimFrame(
                        function() {plaudits_6_draw(c,staticImg,clip)
                });

                var delta = Date.now() - lastUpdateTime;
                if (acDelta > msPerFrame)
                {
                    acDelta = 0;
                    plaudits_6_render(c,clip);
                }
                else
                {
                    acDelta += delta;
                }
                lastUpdateTime = Date.now();
            }
        }

        function plaudits_6_playSound(clip) {

            var sound = clip[0];
            sound.volume = 1;

            if (plaudits_6_soundPlayCount > 0) {
                sound.pause();
                sound.currentTime = 0;
            }

            // limit sound loop
            if (plaudits_6_soundPlayCount === 3) {
                plaudits_6_soundPlayCount = 0;
                plaudits_6_stopSoundLoop = true;
            }
            else
            {
                sound.play();
                plaudits_6_soundPlayCount++;
            }
        }

        function plaudits_6_setIsSoundSupported(me) {

            var clip = me.find('.clip');

            clip.find('source').each(function() {
                // !! converts value to a boolean and ensures a boolean type.
                if (!!(this.parentNode.canPlayType && this.parentNode.canPlayType($(this).attr('type')).replace(/no/, ''))) {
                    plaudits_6_isSoundSupported = true;
                    return false;
                }
            });
            return clip;
        }


        function plaudits_6_loaded(staticImg) {

            var me = $(this).closest('.plaudits-6');
            if (navigator.userAgent.toLowerCase().indexOf('msie') === -1) {
                me.removeClass('msie');

                if (staticImg)
                    me.removeClass('editor');

                setTimeout(function() {

                    me.data('tick', 0);
                    var canvas = me.find('.canvas'),
                            width = me.width(),
                            height = me.height();
                    canvas.css({
                        width : width,
                        height : height
                    });
                    if (pixelRatio) {
                        canvas.attr({
                            'width' : width * pixelRatio,
                            'height' : height * pixelRatio
                        });
                    }

                    var clip = plaudits_6_setIsSoundSupported(me);
                    var id = Math.floor(Math.random() * new Date().getTime());
                    canvas.attr('id', id);

                    plaudits_6_draw(id, staticImg, clip);

                }, 200);
            }
            // bind click event - allow sound to loop if clicked
            me.click(function(e) {
                e.preventDefault();
                plaudits_6_stopSoundLoop = false;
            });
        }
    </script>
    <div class="plaudits-6 msie">
        <img src="http://media.parlingo.com/website/live/messagepacks/gavintest/shared/tinytrans.gif" class="loader" onload="plaudits_6_loaded.call(this);">
        <div class="plaudits-6-header">
            <span class="timestamp"></span>
            <span class="flags"></span>
            <strong class="nickname"></strong>
        </div>
        <div class="blob"></div>
        <canvas class="canvas"></canvas>

        <audio preload="auto" class="clip">
            <source src="http://media.parlingo.com/website/live/messagepacks/gavintest/pc-errors/Chord.wav" type="audio/x-wav">
            <source src="http://media.parlingo.com/website/live/messagepacks/gavintest/pc-errors/Chord.mp3" type="audio/mpeg">
            <source src="http://media.parlingo.com/website/live/messagepacks/gavintest/pc-errors/Chord.ogg" type="audio/ogg">
            <source src="http://media.parlingo.com/website/live/messagepacks/gavintest/pc-errors/Chord.m4a" type="audio/mp4a-latm">
        </audio>
    </div>

    <div class="plaudits-6 editor">
        <img src="http://media.parlingo.com/website/live/messagepacks/gavintest/shared/tinytrans.gif" class="loader" onload="plaudits_6_loaded.call(this, true);">
        <div class="blob"></div>
        <canvas class="canvas"></canvas>
    </div>

</div>
</body>
</html>
